(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{448:function(t,s,e){"use strict";e.r(s);var a=e(55),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"offsite-backups"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#offsite-backups"}},[t._v("#")]),t._v(" Offsite backups")]),t._v(" "),e("p",[t._v("Phab supports onsite- and offsite-backups. Onsite means, the backups are stored on the same host as the application is run. Depending on the hosting setup this might not be enough as the backups might not be stored forever, e.g. if the backup folder is not mapped to a persistent volume in Kubernetes.")]),t._v(" "),e("p",[t._v("That's why phab supports offsite-backups beginning with 3.6 using "),e("a",{attrs:{href:"https://restic.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("restic"),e("OutboundLink")],1),t._v(". Restic is a powerful backup application, with no dependencies, easy to install and supports multiple hosts and encrypted backups. Restic itself supports different storage-providers.")]),t._v(" "),e("p",[t._v("Phabalicious will try to install restic if it cant find an executable on the host.")]),t._v(" "),e("h2",{attrs:{id:"an-example-configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#an-example-configuration"}},[t._v("#")]),t._v(" An example configuration")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secrets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restic")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("question")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" What is the password for restic\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("knownHosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" myhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("myport\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restic")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RESTIC_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" %secrets.restic%\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("repository")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sftp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//myuser@myhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("myport/offsite"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("backups\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("options")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("verbose\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("downloadUrl")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://github.com/restic/restic/releases/download/v0.12.0/restic_0.12.0_linux_amd64.bz2'")]),t._v("\n")])])]),e("table",[e("thead",[e("tr",[e("th",[t._v("key")]),t._v(" "),e("th",[t._v("Description")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("environment")])]),t._v(" "),e("td",[t._v("a dicitionary with all environment variables to pass to restic.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("repository")])]),t._v(" "),e("td",[t._v("The target repository to store the backup into.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("options")])]),t._v(" "),e("td",[t._v("A list of additional options to pass to restic")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("downloadUrl")])]),t._v(" "),e("td",[t._v("In case restic is not found for a particular host, this settings contains the download-url. Phab will use "),e("code",[t._v("curl")]),t._v(" and "),e("code",[t._v("bunzip2")]),t._v(" to download and install the binary")])])])]),t._v(" "),e("p",[t._v("When running "),e("code",[t._v("phab -cconfig backup")]),t._v(" this will backup the database dump and the file directories to the "),e("code",[t._v("offsite-backups")]),t._v(" repository.")]),t._v(" "),e("p",[t._v("Make sure to add an entry to "),e("code",[t._v("knownHosts")]),t._v(" when you are using a sftp repository, otherwise the backups might fail because the host is unknown to the local ssh.")]),t._v(" "),e("h2",{attrs:{id:"how-phabalicious-stores-metadata-into-the-repository"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#how-phabalicious-stores-metadata-into-the-repository"}},[t._v("#")]),t._v(" How phabalicious stores metadata into the repository")]),t._v(" "),e("p",[t._v("Phabalicious encodes the project- and the config-name as the hostname when doing backups. That means you can reuse a repository for multiple configurations and even projects. This might be handy if they share files etc as restic support deduplication. When listing backups or restoring backups, phabalicious will filter the snapshots in the repository by config- and project-name. But you can interact with the repo just using restic.")]),t._v(" "),e("h2",{attrs:{id:"list-backups"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#list-backups"}},[t._v("#")]),t._v(" List backups")]),t._v(" "),e("p",[t._v("List backups will list all snapshots for that particular config and project.")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("‚ùØ phab list:backups\n\n\nList of backups\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\n ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------\n  Date         Time       Type     Hash                                           File\n ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------\n  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v("-03-16   05:03:55   restic   projectname--mbb--cf421674                     /var/www/backups/mbb--0.1.41-6-g8bf90d5--2021-03-16--17-45-53.sql.gz\n                                                                                  /var/www/web/sites/default/files\n  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v("-03-15   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("-45-40   db       mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40   mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40.sql.gz\n  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v("-03-15   09:03:43   restic   projectname--mbb--26a61863                     /var/www/backups/mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40.sql.gz\n                                                                                  /var/www/web/sites/default/files\n ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------\n")])])]),e("p",[t._v("Note the duplication of the backupd database dumps. To restore a database dump, you need to run 2 restores: one, to restore the actual sql file then another one to restore the sql back into the database.")]),t._v(" "),e("h2",{attrs:{id:"restoring-a-backup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#restoring-a-backup"}},[t._v("#")]),t._v(" Restoring a backup")]),t._v(" "),e("p",[t._v("It's the same as ususal, just run "),e("code",[t._v("phab -cconfig restore <backup-hash>")]),t._v(" e.g. "),e("code",[t._v("phab -cmbb restore projectname--mbb--26a61863")]),t._v(". But use that with caution, as it might override exsiting files! If you want to restore the files to a different destination, use restic directly.")])])}),[],!1,null,null,null);s.default=n.exports}}]);