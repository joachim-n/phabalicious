<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes integration | Phabalicious</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="A deployment system and general purpose helper">
    
    <link rel="preload" href="/assets/css/0.styles.f9edc7ac.css" as="style"><link rel="preload" href="/assets/js/app.6b382d26.js" as="script"><link rel="preload" href="/assets/js/3.2184e550.js" as="script"><link rel="preload" href="/assets/js/26.8f705b32.js" as="script"><link rel="prefetch" href="/assets/js/10.51e494e5.js"><link rel="prefetch" href="/assets/js/11.07753871.js"><link rel="prefetch" href="/assets/js/12.8921015e.js"><link rel="prefetch" href="/assets/js/13.ed780963.js"><link rel="prefetch" href="/assets/js/14.68947b36.js"><link rel="prefetch" href="/assets/js/15.364a6690.js"><link rel="prefetch" href="/assets/js/16.24f8eca2.js"><link rel="prefetch" href="/assets/js/17.babaec76.js"><link rel="prefetch" href="/assets/js/18.c99d6156.js"><link rel="prefetch" href="/assets/js/19.81b07e7a.js"><link rel="prefetch" href="/assets/js/20.8eee2bea.js"><link rel="prefetch" href="/assets/js/21.ef9b0481.js"><link rel="prefetch" href="/assets/js/22.c337b1e1.js"><link rel="prefetch" href="/assets/js/23.fad1451d.js"><link rel="prefetch" href="/assets/js/24.79aefc24.js"><link rel="prefetch" href="/assets/js/25.a079a898.js"><link rel="prefetch" href="/assets/js/27.828f7a63.js"><link rel="prefetch" href="/assets/js/28.f7b6d275.js"><link rel="prefetch" href="/assets/js/29.159a173c.js"><link rel="prefetch" href="/assets/js/30.16e78a4f.js"><link rel="prefetch" href="/assets/js/31.b2e2bbf0.js"><link rel="prefetch" href="/assets/js/32.265cdd80.js"><link rel="prefetch" href="/assets/js/4.bc2a6058.js"><link rel="prefetch" href="/assets/js/5.0c470a50.js"><link rel="prefetch" href="/assets/js/6.29119eaa.js"><link rel="prefetch" href="/assets/js/7.e7ee370b.js"><link rel="prefetch" href="/assets/js/8.e34e246f.js"><link rel="prefetch" href="/assets/js/9.7b58ddf7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.b9a44f16.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9edc7ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Phabalicious</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/factorial-io/phabalicious" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/factorial-io/phabalicious" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/guide.html" class="sidebar-heading clickable open"><span>Documentation</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide.html" class="sidebar-link">How does phabalicious work in two sentences</a></li><li><a href="/installation.html" class="sidebar-link">Installation</a></li><li><a href="/usage.html" class="sidebar-link">Running phabalicious</a></li><li><a href="/configuration.html" class="sidebar-link">Structure of the configuration file</a></li><li><a href="/commands.html" class="sidebar-link">Available commands</a></li><li><a href="/inheritance.html" class="sidebar-link">Inheritance</a></li><li><a href="/docker-integration.html" class="sidebar-link">Docker integration</a></li><li><a href="/workspace.html" class="sidebar-link">Setup a local dev environment (multibasebox)</a></li><li><a href="/scripts.html" class="sidebar-link">Scripts</a></li><li><a href="/scaffolder.html" class="sidebar-link">Scaffolding arbitrary files</a></li><li><a href="/app-scaffold.html" class="sidebar-link">Scaffolding a new app</a></li><li><a href="/app-create-destroy.html" class="sidebar-link">Creating/ destroying an app from existing configuration</a></li><li><a href="/deploying-artifacts.html" class="sidebar-link">Deploying artifacts</a></li><li><a href="/kubernetes.html" aria-current="page" class="active sidebar-link">Kubernetes integration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes.html#host-configuration" class="sidebar-link">Host-Configuration</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-defaults" class="sidebar-link">The defaults</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#scaffolding-yml-definitions" class="sidebar-link">Scaffolding yml definitions</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#working-with-contexts" class="sidebar-link">Working with contexts</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#getting-a-shell-to-one-of-the-pods" class="sidebar-link">Getting a shell to one of the pods</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#k8s-subcommands" class="sidebar-link">k8s subcommands</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes.html#the-scaffold-subcommand" class="sidebar-link">the scaffold subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-apply-subcommand" class="sidebar-link">the apply subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-delete-subcommand" class="sidebar-link">the delete subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-kubectl-subcommand" class="sidebar-link">the kubectl subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-rollout-subcommand" class="sidebar-link">the rollout subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-describe-subcommand" class="sidebar-link">the describe subcommand</a></li><li class="sidebar-sub-header"><a href="/kubernetes.html#the-logs-subcommand" class="sidebar-link">the logs subcommand</a></li></ul></li><li class="sidebar-sub-header"><a href="/kubernetes.html#integration-into-the-deployment-process-of-phabalicious" class="sidebar-link">Integration into the deployment process of phabalicious</a></li></ul></li><li><a href="/offsite-backups.html" class="sidebar-link">Offsite backups</a></li><li><a href="/local-overrides.html" class="sidebar-link">Local overrides</a></li><li><a href="/passwords.html" class="sidebar-link">Passwords and secrets</a></li><li><a href="/contribute.html" class="sidebar-link">Contributing to Phabalicious</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/" class="sidebar-heading clickable"><span>Blog</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/introduction.html" class="sidebar-link">A short introduction into phabalicious</a></li><li><a href="/blog/architecture.html" class="sidebar-link">Introduction and overall architecture</a></li><li><a href="/blog/whats-new-in-phab-3-7.html" class="sidebar-link">What's new in phabalicious 3.7?</a></li><li><a href="/blog/how-to-use-secrets.html" class="sidebar-link">Handling secrets with phabalicious</a></li></ul></section></li><li><a href="/Changelog.html" class="sidebar-link">Changelog</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes-integration"><a href="#kubernetes-integration" class="header-anchor">#</a> Kubernetes integration</h1> <p>Phabalicious can help you integrating your app with a Kubernetes stack and running your common tasks against an installation hosted on a Kubernetes cluster. You can leverage phabalicious scaffolder to create yml definitions for your app and apply them to your cluster automatically. Phab can also help you getting a shell to one of your pods.</p> <p><strong>Note:</strong>
The current version of phabalicious does not support any kind of authorization or authentication. It expects that the local environment is set up correctly for executing <code>kubectl</code>!</p> <h2 id="host-configuration"><a href="#host-configuration" class="header-anchor">#</a> Host-Configuration</h2> <p>All necessary configuration is located under the <code>kube</code>-property. You can use replacement-patterns to use placeholder to replace certain values. Here's an example:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token key atrule">k8s-example</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> k8s
    <span class="token key atrule">kube</span><span class="token punctuation">:</span>
      <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token string">&quot;%globals.userFolder%/.kube/my-config&quot;</span>
      <span class="token key atrule">environment</span><span class="token punctuation">:</span>
        <span class="token key atrule">SOME_VAR</span><span class="token punctuation">:</span> some_value
      <span class="token key atrule">context</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>context
      <span class="token key atrule">scaffolder</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseUrl</span><span class="token punctuation">:</span> ./public/scaffold/kube
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> factorial<span class="token punctuation">-</span>infra
      <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> app=%host.kube.parameters.name%
        <span class="token punctuation">-</span> type=%host.type%
      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> config
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> config.factorial.io
        <span class="token key atrule">projectSlug</span><span class="token punctuation">:</span> config
        <span class="token key atrule">dockerImage</span><span class="token punctuation">:</span> registry.factorial.io<span class="token punctuation">:</span>8443/administration/config<span class="token punctuation">:</span>latest
        <span class="token key atrule">letsencrypt</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h2 id="the-defaults"><a href="#the-defaults" class="header-anchor">#</a> The defaults</h2> <p>The Kubernetes intergration provides sensible defaults for most use-cases. These defaults can be overridden via the actual configuration.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token key atrule">k8s-exampl</span><span class="token punctuation">:</span>
    <span class="token key atrule">shellExecutable</span><span class="token punctuation">:</span> /bin/sh
    <span class="token key atrule">kubectlExecutable</span><span class="token punctuation">:</span> kubectl
    <span class="token key atrule">kubectlOptions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">kube</span><span class="token punctuation">:</span>
      <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
      <span class="token key atrule">scaffolder</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseUrl</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//config.factorial.io/scaffold/kube
        <span class="token key atrule">template</span><span class="token punctuation">:</span> simple/index.yml
      <span class="token key atrule">scaffoldBeforeApply</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">applyBeforeDeploy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">waitAfterApply</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">projectFolder</span><span class="token punctuation">:</span> kube
      <span class="token key atrule">applyCommand</span><span class="token punctuation">:</span> <span class="token string">'apply -k .'</span>
      <span class="token key atrule">deleteCommand</span><span class="token punctuation">:</span> <span class="token string">'delete -k .'</span>
      <span class="token key atrule">deployments</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">'%host.kube.parameters.name%'</span>
</code></pre></div><table><thead><tr><th>Property</th> <th>Description</th> <th>Example</th></tr></thead> <tbody><tr><td><code>shellExecutable</code></td> <td>What shell to execute inside the pod.</td> <td><code>/bin/sh</code></td></tr> <tr><td><code>kubectlExecutable</code></td> <td>The name of the kubectl executable</td> <td><code>kubectl</code></td></tr> <tr><td><code>kubectlOptions</code></td> <td>array with command-line options for kubectl, in the format <code>--option: value</code></td> <td><code>- --insecure-skip-tls-verify: &quot;&quot;</code></td></tr> <tr><td><code>kube.kubeconfig</code></td> <td>the kubeconfig to use for any kubectl command</td> <td><code>%globals.userFolder%/.kube/my-kube-config</code></td></tr> <tr><td><code>kube.context</code></td> <td>the context to switch before calling any kubectl command</td> <td></td></tr> <tr><td><code>kube.environment</code></td> <td>An array of environment variables to set before calling any kubectl command.</td> <td></td></tr> <tr><td><code>kube.namespace</code></td> <td>The namespace to apply to all kubectl commands</td> <td><code>myapp</code></td></tr> <tr><td><code>kube.scaffolder.baseUrl</code></td> <td>Base-URL for the scaffolder</td> <td></td></tr> <tr><td><code>kube.scaffolder.template</code></td> <td>the template file name to use when scaffolding the definition files</td> <td></td></tr> <tr><td><code>kube.scaffoldBeforeApply</code></td> <td>If set to true, the definition files will be scaffolded before they get applied</td> <td><code>true</code></td></tr> <tr><td><code>kube.waitAfterApply</code></td> <td>Wait until deployment is finished after apply. Needs <code>deployments</code> with sensible data</td> <td><code>true</code></td></tr> <tr><td><code>kube.projectFolder</code></td> <td>Where the definition files are stored, also the target for the scaffolding step</td> <td><code>kube</code></td></tr> <tr><td><code>kube.applyCommand</code></td> <td>What command to run to apply the definition files to the cluster</td> <td><code>apply -k .</code></td></tr> <tr><td><code>kube.deleteCommand</code></td> <td>What command to run to delete the app from the cluster</td> <td><code>delete -k .</code></td></tr> <tr><td><code>kube.deployments</code></td> <td>An array of deployment names to check if the deployment is finished</td> <td><code>- %host.kube.parameters.name%</code></td></tr></tbody></table> <h2 id="scaffolding-yml-definitions"><a href="#scaffolding-yml-definitions" class="header-anchor">#</a> Scaffolding yml definitions</h2> <p>Phab can scaffold your yml definition files before running a deployment or on request. You can use all the possibilities from the scaffolding engine and store your parameters inside the fabfile.yaml. This allows you to reuse existing configuration and adapt your Kubernetes definition files to environment specific settings.</p> <p>For this to work your <code>kube</code>-section needs to contain the following parts:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token key atrule">k8s-example</span><span class="token punctuation">:</span>
    <span class="token key atrule">kube</span><span class="token punctuation">:</span>
      <span class="token key atrule">projectFolder</span><span class="token punctuation">:</span> kube/
      <span class="token key atrule">scaffolder</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseUrl</span><span class="token punctuation">:</span> ./path/to/folder/with/templates <span class="token comment"># Can be a url</span>
        <span class="token key atrule">template</span><span class="token punctuation">:</span> ./path/to/template.yml
      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> name of the project
        <span class="token key atrule">projectSlug</span><span class="token punctuation">:</span> slug<span class="token punctuation">-</span>of<span class="token punctuation">-</span>the<span class="token punctuation">-</span>project
</code></pre></div><p>Phab will use the yml file from baseUrl and template and run the scaffold script from there. <code>parameters</code> are available in the twig templates for replacement and via the <code>%parameter%</code>-notation available in file-names etc. Additionally the complete host-parameters are available via <code>host.property_name</code>, e.g. <code>host.kube.projectFolder</code> (Surrounded by double curly braces or percents)</p> <p>Phab adds the following parameters automatically:</p> <table><thead><tr><th>Property</th> <th>Description</th> <th>Example</th></tr></thead> <tbody><tr><td><code>scaffoldTimeStamp</code></td> <td>a slugified timestamp when the scaffolding was done. Useful to indicate a change in the definition so Kubernetes will recreate a pod for example.</td> <td><code>20200721-083614Z</code></td></tr> <tr><td><code>host.*</code></td> <td>The current host configuration</td> <td><code>host.rootFolder</code>, <code>host.kube.namespace</code></td></tr> <tr><td><code>namespace</code></td> <td>The namespace taken from the kube config, defaults to <code>default</code></td> <td><code>my-namespace</code></td></tr></tbody></table> <p>An example scaffold.yml-file:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">requires</span><span class="token punctuation">:</span> <span class="token number">3.5</span>

<span class="token key atrule">questions</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token key atrule">question</span><span class="token punctuation">:</span> Hosts for the site
    <span class="token key atrule">type</span><span class="token punctuation">:</span> array

  <span class="token key atrule">projectSlug</span><span class="token punctuation">:</span>
    <span class="token key atrule">question</span><span class="token punctuation">:</span> Name of the project
    <span class="token key atrule">validation</span><span class="token punctuation">:</span> <span class="token string">&quot;/^[a-z0-9]+(?:-[a-z0-9]+)*$/&quot;</span>
    <span class="token key atrule">error</span><span class="token punctuation">:</span> Name should only ontain alphanumerics and hyphens

  <span class="token key atrule">letsencrypt</span><span class="token punctuation">:</span>
    <span class="token key atrule">question</span><span class="token punctuation">:</span> Use letsencrypt
    <span class="token key atrule">type</span><span class="token punctuation">:</span> confirm
    <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">namespace</span><span class="token punctuation">:</span>
    <span class="token key atrule">question</span><span class="token punctuation">:</span> Which namespace to deploy to

<span class="token key atrule">assets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> 00<span class="token punctuation">-</span>app<span class="token punctuation">-</span>secrets.yml
  <span class="token punctuation">-</span> 01<span class="token punctuation">-</span>pvc.yml
  <span class="token punctuation">-</span> 02<span class="token punctuation">-</span>deployment.yml
  <span class="token punctuation">-</span> 03<span class="token punctuation">-</span>service.yml
  <span class="token punctuation">-</span> 04<span class="token punctuation">-</span>ingress.yml
  <span class="token punctuation">-</span> kustomization.yml

<span class="token key atrule">scaffold</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> copy_assets(%rootFolder%<span class="token punctuation">,</span> assets)
  <span class="token punctuation">-</span> log_message(success<span class="token punctuation">,</span> The scaffolded files are stored in the kube<span class="token punctuation">-</span>folder)
</code></pre></div><p>This will prompt for any missing property in <code>parameters</code> via the questions block and then scaffold the yml files to the projectFolder.</p> <p>Here's an example yml definition:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">project</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> projectSlug <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> host.type <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">buildDate</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> scaffoldTimestamp <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;{{dockerImage}}&quot;</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> containerPort <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> containerPort <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> registry<span class="token punctuation">-</span>secrets
</code></pre></div><h2 id="working-with-contexts"><a href="#working-with-contexts" class="header-anchor">#</a> Working with contexts</h2> <p>phab can support different contexts, just add the name of the context to the <code>kube</code>-configuration. Phab will switch to that context before doing any work, and restore the context afterwards. If an error happens, the context might not get restored correctly.</p> <p>The preferred way to use different clusters with phabalicious is to have dedicated kubeconfig files and reference them in the project via the <code>kubeconfig</code>-property, e.g.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token key atrule">example</span><span class="token punctuation">:</span>
    <span class="token key atrule">kube</span><span class="token punctuation">:</span>
      <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token string">&quot;%globals.userFolder%/.kube/my-config&quot;</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>context
</code></pre></div><p>This will make sure, that the context is not available after phab finished its work. You can use replacement patterns for the value of kubeconfig.</p> <h2 id="getting-a-shell-to-one-of-the-pods"><a href="#getting-a-shell-to-one-of-the-pods" class="header-anchor">#</a> Getting a shell to one of the pods</h2> <p>Phab contains a shell-provider for Kubernetes, but it needs some guidance so it knows which pod to connect to. Phab is using a set of selectors to acquire the name of the actual running pod. As every project is different it makes sense to store this information in the <code>kube</code>-section of your host configuration:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token key atrule">k8s-example</span><span class="token punctuation">:</span>
    <span class="token key atrule">kube</span><span class="token punctuation">:</span>
      <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span>service_type=%host.kube.serviceName%
      <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> builder
      <span class="token punctuation">...</span>
</code></pre></div><p>The <code>podSelector</code> contains one or more selectors which get appended to the kubctl call to get the name of the pod. In the above example the podSelector is using a <code>%property%</code> to use another property of the kube config. This makes it easy to change the pod-selector via the <code>--set</code>-option. Phab will also query the actual deployment and the relevant replicaset to append a <code>pod-template-hash</code> selector to the query to make sure, to connect to the latest pod.</p> <p>To actually start a shell:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> shell
</code></pre></div><p>This should open an interactive shell on your selected pod.</p> <p>To override the pod-selector in the above example:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> shell --set host.kube.serviceName<span class="token operator">=</span>nginx
</code></pre></div><p>this will open a shell to the pod which is the result of the selector <code>service_type=nginx</code>. The actual command will look like this: <code>kubectl get pods --namespace &lt;the-namespace&gt; -l &lt;the-pod-selector&gt; -o json</code></p> <p>The shell is also used to run parts of the other commands like <code>reset</code>, <code>deploy</code>, etc.</p> <h2 id="k8s-subcommands"><a href="#k8s-subcommands" class="header-anchor">#</a> k8s subcommands</h2> <p>the <code>k8s</code> provides a list of sub-commands, which maps to corresponding <code>kubectl</code> commands for the most popular use cases. Phab will provide the namespace option when needed and change the current directory to the kube project folder.</p> <h3 id="the-scaffold-subcommand"><a href="#the-scaffold-subcommand" class="header-anchor">#</a> the <code>scaffold</code> subcommand</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s scaffold
</code></pre></div><p>This will run the scaffolder to produce a new set of definition files. Nothing more. The files will be scaffolded to the kube project folder.</p> <h3 id="the-apply-subcommand"><a href="#the-apply-subcommand" class="header-anchor">#</a> the <code>apply</code> subcommand</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s apply
</code></pre></div><p>Applies the definitions files using <code>kubectl</code> and the property <code>applyCommand</code> from the kube-configuration. The <code>applyCommand</code> defaults to <code>apply -t .</code></p> <p>If <code>scaffoldBeforeApply</code> is set to true, the yml definitions get scaffolded before running apply.</p> <p>If <code>waitAfterApply</code> is true, then phab will wait for the end of the deployment using <code>kubectl rollout status</code>. This means the execution is blocked until the app is available again and the rollout is finished. Make sure your <code>deployments</code>-configuration is uptodate, as phab needs to know which deployments need to be checked. You can use the <code>%property%</code> notation to reference the kube configuration.</p> <p>Here's an example:</p> <div class="language- extra-class"><pre class="language-text"><code>hosts:
  test-k8s:
    kube:
      deployments:
        - &quot;%host.kube.parameters.name%-builder&quot;
        - &quot;%host.kube.parameters.name%-nginx&quot;
        - &quot;%host.kube.parameters.name%-php&quot;
      parameters:
        name: my-app
</code></pre></div><p>Phab will check the status of the rollouts for <code>my-app-builder</code>, <code>my-app-nginx</code>, <code>my-app-php</code> before continuing.</p> <p>You should limit the list of deployments only to the necessary ones to you need to interact to.</p> <h3 id="the-delete-subcommand"><a href="#the-delete-subcommand" class="header-anchor">#</a> the <code>delete</code> subcommand</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s delete
</code></pre></div><p>Run the <code>deleteCommand</code> to delete the current specs from the cluster.</p> <h3 id="the-kubectl-subcommand"><a href="#the-kubectl-subcommand" class="header-anchor">#</a> the <code>kubectl</code> subcommand</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s kubectl -- <span class="token operator">&lt;</span>args_for_kubectl<span class="token operator">&gt;</span>
</code></pre></div><p>Run <code>kubectl</code> and applying the info from the kube config in the fabfile.</p> <p>An example:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s kubectl get pods
</code></pre></div><h3 id="the-rollout-subcommand"><a href="#the-rollout-subcommand" class="header-anchor">#</a> the <code>rollout</code> subcommand</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s rollout -- <span class="token operator">&lt;</span>args_for_rollout<span class="token operator">&gt;</span>
</code></pre></div><p>Run <code>kubectl rollout</code> and applying the info from the kube config in the fabfile.</p> <p>An example:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>phab -c<span class="token operator">&lt;</span>config<span class="token operator">&gt;</span> k8s rollout <span class="token function">history</span> deployments/nginx
</code></pre></div><h3 id="the-describe-subcommand"><a href="#the-describe-subcommand" class="header-anchor">#</a> the <code>describe</code> subcommand</h3> <p>This subcommand will describe the pod desribed by the podSelector:</p> <div class="language- extra-class"><pre class="language-text"><code>phab -c&lt;config&gt; k8s decribe
</code></pre></div><p>It uses the same podSelector mechanism as described under &quot;Getting a shell&quot;</p> <h3 id="the-logs-subcommand"><a href="#the-logs-subcommand" class="header-anchor">#</a> the <code>logs</code> subcommand</h3> <p>This subcommand will print out the logs of a particular pod:</p> <div class="language- extra-class"><pre class="language-text"><code>phab -c&lt;config&gt; k8s logs
</code></pre></div><p>It uses the same podSelector mechanism as described under &quot;Getting a shell&quot;</p> <h2 id="integration-into-the-deployment-process-of-phabalicious"><a href="#integration-into-the-deployment-process-of-phabalicious" class="header-anchor">#</a> Integration into the deployment process of phabalicious</h2> <p>It depends on your project setup if it makes sense to scaffold and apply the definition files when runnning a regular deployment. If you want to opt in you need to set <code>applyBeforeDeploy</code> to true. If set to true phabalicious will apply your definition files and depending on <code>waitAfterApply</code> and <code>scaffoldBeforeDeploy</code> even scaffold the definition files and/ or wait for the successful rollout. All this is run on the <code>deployPrepare</code>-stage</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/factorial-io/phabalicious/edit/master/docs/kubernetes.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/deploying-artifacts.html" class="prev">
        Deploying artifacts
      </a></span> <span class="next"><a href="/offsite-backups.html">
        Offsite backups
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6b382d26.js" defer></script><script src="/assets/js/3.2184e550.js" defer></script><script src="/assets/js/26.8f705b32.js" defer></script>
  </body>
</html>
