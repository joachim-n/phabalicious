<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Offsite backups | Phabalicious</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="A deployment system and general purpose helper">
    
    <link rel="preload" href="/assets/css/0.styles.f9edc7ac.css" as="style"><link rel="preload" href="/assets/js/app.6b382d26.js" as="script"><link rel="preload" href="/assets/js/3.2184e550.js" as="script"><link rel="preload" href="/assets/js/28.f7b6d275.js" as="script"><link rel="prefetch" href="/assets/js/10.51e494e5.js"><link rel="prefetch" href="/assets/js/11.07753871.js"><link rel="prefetch" href="/assets/js/12.8921015e.js"><link rel="prefetch" href="/assets/js/13.ed780963.js"><link rel="prefetch" href="/assets/js/14.68947b36.js"><link rel="prefetch" href="/assets/js/15.364a6690.js"><link rel="prefetch" href="/assets/js/16.24f8eca2.js"><link rel="prefetch" href="/assets/js/17.babaec76.js"><link rel="prefetch" href="/assets/js/18.c99d6156.js"><link rel="prefetch" href="/assets/js/19.81b07e7a.js"><link rel="prefetch" href="/assets/js/20.8eee2bea.js"><link rel="prefetch" href="/assets/js/21.ef9b0481.js"><link rel="prefetch" href="/assets/js/22.c337b1e1.js"><link rel="prefetch" href="/assets/js/23.fad1451d.js"><link rel="prefetch" href="/assets/js/24.79aefc24.js"><link rel="prefetch" href="/assets/js/25.a079a898.js"><link rel="prefetch" href="/assets/js/26.8f705b32.js"><link rel="prefetch" href="/assets/js/27.828f7a63.js"><link rel="prefetch" href="/assets/js/29.159a173c.js"><link rel="prefetch" href="/assets/js/30.16e78a4f.js"><link rel="prefetch" href="/assets/js/31.b2e2bbf0.js"><link rel="prefetch" href="/assets/js/32.265cdd80.js"><link rel="prefetch" href="/assets/js/4.bc2a6058.js"><link rel="prefetch" href="/assets/js/5.0c470a50.js"><link rel="prefetch" href="/assets/js/6.29119eaa.js"><link rel="prefetch" href="/assets/js/7.e7ee370b.js"><link rel="prefetch" href="/assets/js/8.e34e246f.js"><link rel="prefetch" href="/assets/js/9.7b58ddf7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.b9a44f16.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9edc7ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Phabalicious</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/factorial-io/phabalicious" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/factorial-io/phabalicious" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/guide.html" class="sidebar-heading clickable open"><span>Documentation</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide.html" class="sidebar-link">How does phabalicious work in two sentences</a></li><li><a href="/installation.html" class="sidebar-link">Installation</a></li><li><a href="/usage.html" class="sidebar-link">Running phabalicious</a></li><li><a href="/configuration.html" class="sidebar-link">Structure of the configuration file</a></li><li><a href="/commands.html" class="sidebar-link">Available commands</a></li><li><a href="/inheritance.html" class="sidebar-link">Inheritance</a></li><li><a href="/docker-integration.html" class="sidebar-link">Docker integration</a></li><li><a href="/workspace.html" class="sidebar-link">Setup a local dev environment (multibasebox)</a></li><li><a href="/scripts.html" class="sidebar-link">Scripts</a></li><li><a href="/scaffolder.html" class="sidebar-link">Scaffolding arbitrary files</a></li><li><a href="/app-scaffold.html" class="sidebar-link">Scaffolding a new app</a></li><li><a href="/app-create-destroy.html" class="sidebar-link">Creating/ destroying an app from existing configuration</a></li><li><a href="/deploying-artifacts.html" class="sidebar-link">Deploying artifacts</a></li><li><a href="/kubernetes.html" class="sidebar-link">Kubernetes integration</a></li><li><a href="/offsite-backups.html" aria-current="page" class="active sidebar-link">Offsite backups</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/offsite-backups.html#an-example-configuration" class="sidebar-link">An example configuration</a></li><li class="sidebar-sub-header"><a href="/offsite-backups.html#how-phabalicious-stores-metadata-into-the-repository" class="sidebar-link">How phabalicious stores metadata into the repository</a></li><li class="sidebar-sub-header"><a href="/offsite-backups.html#list-backups" class="sidebar-link">List backups</a></li><li class="sidebar-sub-header"><a href="/offsite-backups.html#restoring-a-backup" class="sidebar-link">Restoring a backup</a></li></ul></li><li><a href="/local-overrides.html" class="sidebar-link">Local overrides</a></li><li><a href="/passwords.html" class="sidebar-link">Passwords and secrets</a></li><li><a href="/contribute.html" class="sidebar-link">Contributing to Phabalicious</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/" class="sidebar-heading clickable"><span>Blog</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/introduction.html" class="sidebar-link">A short introduction into phabalicious</a></li><li><a href="/blog/architecture.html" class="sidebar-link">Introduction and overall architecture</a></li><li><a href="/blog/whats-new-in-phab-3-7.html" class="sidebar-link">What's new in phabalicious 3.7?</a></li><li><a href="/blog/how-to-use-secrets.html" class="sidebar-link">Handling secrets with phabalicious</a></li></ul></section></li><li><a href="/Changelog.html" class="sidebar-link">Changelog</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="offsite-backups"><a href="#offsite-backups" class="header-anchor">#</a> Offsite backups</h1> <p>Phab supports onsite- and offsite-backups. Onsite means, the backups are stored on the same host as the application is run. Depending on the hosting setup this might not be enough as the backups might not be stored forever, e.g. if the backup folder is not mapped to a persistent volume in Kubernetes.</p> <p>That's why phab supports offsite-backups beginning with 3.6 using <a href="https://restic.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">restic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Restic is a powerful backup application, with no dependencies, easy to install and supports multiple hosts and encrypted backups. Restic itself supports different storage-providers.</p> <p>Phabalicious will try to install restic if it cant find an executable on the host.</p> <h2 id="an-example-configuration"><a href="#an-example-configuration" class="header-anchor">#</a> An example configuration</h2> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">secrets</span><span class="token punctuation">:</span>
  <span class="token key atrule">restic</span><span class="token punctuation">:</span>
    <span class="token key atrule">question</span><span class="token punctuation">:</span> What is the password for restic

<span class="token key atrule">knownHosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> myhost<span class="token punctuation">:</span>myport

<span class="token key atrule">restic</span><span class="token punctuation">:</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">RESTIC_PASSWORD</span><span class="token punctuation">:</span> %secrets.restic%
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> sftp<span class="token punctuation">:</span>//myuser@myhost<span class="token punctuation">:</span>myport/offsite<span class="token punctuation">-</span>backups
  <span class="token key atrule">options</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>verbose
  <span class="token key atrule">downloadUrl</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/restic/restic/releases/download/v0.12.0/restic_0.12.0_linux_amd64.bz2'</span>
</code></pre></div><table><thead><tr><th>key</th> <th>Description</th></tr></thead> <tbody><tr><td><code>environment</code></td> <td>a dicitionary with all environment variables to pass to restic.</td></tr> <tr><td><code>repository</code></td> <td>The target repository to store the backup into.</td></tr> <tr><td><code>options</code></td> <td>A list of additional options to pass to restic</td></tr> <tr><td><code>downloadUrl</code></td> <td>In case restic is not found for a particular host, this settings contains the download-url. Phab will use <code>curl</code> and <code>bunzip2</code> to download and install the binary</td></tr></tbody></table> <p>When running <code>phab -cconfig backup</code> this will backup the database dump and the file directories to the <code>offsite-backups</code> repository.</p> <p>Make sure to add an entry to <code>knownHosts</code> when you are using a sftp repository, otherwise the backups might fail because the host is unknown to the local ssh.</p> <h2 id="how-phabalicious-stores-metadata-into-the-repository"><a href="#how-phabalicious-stores-metadata-into-the-repository" class="header-anchor">#</a> How phabalicious stores metadata into the repository</h2> <p>Phabalicious encodes the project- and the config-name as the hostname when doing backups. That means you can reuse a repository for multiple configurations and even projects. This might be handy if they share files etc as restic support deduplication. When listing backups or restoring backups, phabalicious will filter the snapshots in the repository by config- and project-name. But you can interact with the repo just using restic.</p> <h2 id="list-backups"><a href="#list-backups" class="header-anchor">#</a> List backups</h2> <p>List backups will list all snapshots for that particular config and project.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>❯ phab list:backups


List of backups
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

 ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------
  Date         Time       Type     Hash                                           File
 ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------
  <span class="token number">2021</span>-03-16   05:03:55   restic   projectname--mbb--cf421674                     /var/www/backups/mbb--0.1.41-6-g8bf90d5--2021-03-16--17-45-53.sql.gz
                                                                                  /var/www/web/sites/default/files
  <span class="token number">2021</span>-03-15   <span class="token number">21</span>-45-40   db       mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40   mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40.sql.gz
  <span class="token number">2021</span>-03-15   09:03:43   restic   projectname--mbb--26a61863                     /var/www/backups/mbb--0.1.41-6-g8bf90d5--2021-03-15--21-45-40.sql.gz
                                                                                  /var/www/web/sites/default/files
 ------------ ---------- -------- ---------------------------------------------- ----------------------------------------------------------------------
</code></pre></div><p>Note the duplication of the backupd database dumps. To restore a database dump, you need to run 2 restores: one, to restore the actual sql file then another one to restore the sql back into the database.</p> <h2 id="restoring-a-backup"><a href="#restoring-a-backup" class="header-anchor">#</a> Restoring a backup</h2> <p>It's the same as ususal, just run <code>phab -cconfig restore &lt;backup-hash&gt;</code> e.g. <code>phab -cmbb restore projectname--mbb--26a61863</code>. But use that with caution, as it might override exsiting files! If you want to restore the files to a different destination, use restic directly.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/factorial-io/phabalicious/edit/master/docs/offsite-backups.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kubernetes.html" class="prev">
        Kubernetes integration
      </a></span> <span class="next"><a href="/local-overrides.html">
        Local overrides
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6b382d26.js" defer></script><script src="/assets/js/3.2184e550.js" defer></script><script src="/assets/js/28.f7b6d275.js" defer></script>
  </body>
</html>
